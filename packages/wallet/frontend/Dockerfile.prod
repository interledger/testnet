FROM node:18-alpine as base

WORKDIR /testnet

RUN apk add --no-cache \
    libc6-compat \
    python3 \
    make \
    g++

RUN corepack enable
RUN corepack prepare pnpm@8.6.2 --activate

FROM base AS deps 

WORKDIR /testnet

COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .npmrc .nvmrc ./
COPY packages/wallet/frontend/package.json ./packages/wallet/frontend/package.json
RUN pnpm fetch
RUN pnpm install --frozen-lockfile

FROM base AS builder

WORKDIR /testnet

COPY --from=deps /testnet/node_modules /testnet/node_modules
COPY --from=deps /testnet/packages/wallet/frontend/node_modules /testnet/packages/wallet/frontend/node_modules
COPY . .
RUN pnpm wallet:frontend build

FROM base AS runner

WORKDIR /testnet

ARG PORT

ENV NODE_ENV=production
ENV PORT=$PORT

COPY --from=builder /testnet/packages/wallet/frontend/.next/standalone ./
COPY --from=builder /testnet/packages/wallet/frontend/public /testnet/packages/wallet/frontend/public
COPY --from=builder /testnet/packages/wallet/frontend/.next/static /testnet/packages/wallet/frontend/.next/static

CMD ["node", "packages/wallet/frontend/server.js"]
